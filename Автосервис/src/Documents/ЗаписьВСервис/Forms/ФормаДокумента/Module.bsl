&НаКлиенте
Процедура КалькуляцияПриИзменении(Элемент)
    
    Сообщить("Сработало1");
    
    Если НЕ ЗначениеЗаполнено(Объект.Калькуляция) Тогда
        Возврат;
    КонецЕсли;

    // Читаем данные через серверный вызов
    Данные = ЗаполнитьИзКалькуляцииНаСервере(Объект.Калькуляция, Объект.ВариантКалькуляции);
    
    // Обновляем форму
    Если Данные.Свойство("Клиент") Тогда
        Объект.Клиент = Данные.Клиент;
    КонецЕсли;
    
    Если Данные.Свойство("Автомобиль") Тогда
        Объект.Автомобиль = Данные.Автомобиль;
    КонецЕсли;
    
    Если Данные.Свойство("ПричинаОбращения") Тогда
        Объект.ПричинаОбращения = Данные.ПричинаОбращения;
    КонецЕсли;
    
    // Заполняем таблицу работ
    Если Данные.Свойство("Работы") Тогда
        ЗаполнитьТаблицуРабот(Данные.Работы);
    КонецЕсли;
    
    // Заполняем таблицу материалов
    Если Данные.Свойство("Автодетали") Тогда
        ЗаполнитьТаблицуАвтодеталей(Данные.Автодетали);
    КонецЕсли;
    
    
КонецПроцедуры

&НаКлиенте
Процедура ВариантКалькуляцииПриИзменении(Элемент)
    
    Сообщить("Сработало2");
    ОбновитьВсеДанные();
    
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьТаблицуРабот(МассивРабот)
    
    Сообщить("Начало заполнения таблицы работ, количество: " + МассивРабот.Количество());
    
    // Очищаем табличную часть
    Объект.Работы.Очистить();
    
    // Заполняем работы из массива
    Для Каждого Элемент Из МассивРабот Цикл
        НоваяСтрока = Объект.Работы.Добавить();
        
        // Основные поля (проверяем наличие в структуре)
        Если Элемент.Свойство("Работа") Тогда
            НоваяСтрока.Работа = Элемент.Работа;
        КонецЕсли;
        
        Если Элемент.Свойство("НормаЧасов") Тогда
            НоваяСтрока.НормаЧасов = Элемент.НормаЧасов;
        КонецЕсли;
        
        Если Элемент.Свойство("Нормачас") Тогда
            НоваяСтрока.НормаЧасов = Элемент.Нормачас;
        КонецЕсли;
        
        Если Элемент.Свойство("Количество") Тогда
            НоваяСтрока.Количество = Элемент.Количество;
        КонецЕсли;
        
        Если Элемент.Свойство("Автодеталь") Тогда
            НоваяСтрока.Автодеталь = Элемент.Автодеталь;
        КонецЕсли;
        
        // Добавьте другие поля, если они есть в табличной части
        // Если Элемент.Свойство("Стоимость") Тогда
        //     НоваяСтрока.Стоимость = Элемент.Стоимость;
        // КонецЕсли;
        
    КонецЦикла;
    
    // Обновляем отображение таблицы
    Элементы.Работы.Обновить();
    
    Сообщить("Таблица работ заполнена, строк: " + Объект.Работы.Количество());
    
КонецПроцедуры


&НаКлиенте
&НаКлиенте
Процедура ЗаполнитьТаблицуАвтодеталей(МассивАвтодеталей)
    
    Сообщить("Заполняем таблицу автодеталей, строк: " + МассивАвтодеталей.Количество());
    
    // Очищаем табличную часть материалов (автодеталей)
    Объект.Материалы.Очистить();
    
    // Заполняем автодетали из массива
    Для Каждого Элемент Из МассивАвтодеталей Цикл
        НоваяСтрока = Объект.Материалы.Добавить();
        
        // Автодеталь и количество
        Если Элемент.Свойство("Автодеталь") Тогда
            НоваяСтрока.Автодеталь = Элемент.Автодеталь;
        КонецЕсли;
        
        Если Элемент.Свойство("Количество") Тогда
            НоваяСтрока.Количество = Элемент.Количество;
        КонецЕсли;
        
        // Материал, цена и сумма
        Если Элемент.Свойство("Материал") Тогда
            НоваяСтрока.Материал = Элемент.Материал;
        КонецЕсли;
        
        Если Элемент.Свойство("Цена") Тогда
            НоваяСтрока.Цена = Элемент.Цена;
        КонецЕсли;
        
        Если Элемент.Свойство("Сумма") Тогда
            НоваяСтрока.Сумма = Элемент.Сумма;
        КонецЕсли;
        
        // Поле "Деталь клиента" - по умолчанию ЛОЖЬ
        Если НоваяСтрока.Свойство("ДетальКлиента") Тогда
            НоваяСтрока.ДетальКлиента = Ложь;
        КонецЕсли;
        
    КонецЦикла;
    
    // Обновляем отображение таблицы
    Элементы.Материалы.Обновить();
    
КонецПроцедуры


&НаСервере
Функция ЗаполнитьИзКалькуляцииНаСервере(СсылкаКалькуляции, ВариантКалькуляции)
    
    Результат = Новый Структура;
    
    Если Не ЗначениеЗаполнено(СсылкаКалькуляции) Тогда
        Возврат Результат;
    КонецЕсли;
    
    // Получаем объект калькуляции
    ДокументОбъект = СсылкаКалькуляции.ПолучитьОбъект();
    
    // Заполняем структуру данными
    Результат.Вставить("Клиент", ДокументОбъект.Клиент);
    Результат.Вставить("Автомобиль", ДокументОбъект.Автомобиль);
    Результат.Вставить("ПричинаОбращения", ДокументОбъект.ПричинаОбращения);
    
    // Для табличных частей - конвертируем в массив структур
    Результат.Вставить("Работы", ТаблицаЗначенийВМассив(ДокументОбъект.Работы.Выгрузить()));
    
    // Автодетали по выбранному варианту
    Результат.Вставить("Автодетали", ПолучитьАвтодеталиПоВарианту(ДокументОбъект, ВариантКалькуляции));
    
    Возврат Результат;
    
КонецФункции

&НаСервере
Функция ТаблицаЗначенийВМассив(Таблица)
    
    Массив = Новый Массив;
    
    Для Каждого СтрокаТаблицы Из Таблица Цикл
        СтруктураСтроки = Новый Структура();
        
        // Копируем все колонки из строки таблицы
        Для Каждого Колонка Из Таблица.Колонки Цикл
            ИмяКолонки = Колонка.Имя;
            СтруктураСтроки.Вставить(ИмяКолонки, СтрокаТаблицы[ИмяКолонки]);
        КонецЦикла;
        
        Массив.Добавить(СтруктураСтроки);
        
        // Для отладки - выводим строку
        // Сообщить("Добавлена строка: " + СтрокаТаблицы.Работа + ", часов: " + СтрокаТаблицы.НормаЧасов);
    КонецЦикла;
    
    Сообщить("С сервера возвращено " + Массив.Количество() + " строк работ");
    
    Возврат Массив;
    
КонецФункции


&НаСервере
Функция ПолучитьАвтодеталиПоВарианту(ДокументОбъект, ВариантКалькуляции)
    
    МассивАвтодеталей = Новый Массив;
    
    Сообщить("Получаем автодетали для варианта: " + ВариантКалькуляции);
    
    // Если вариант не выбран - НИЧЕГО не возвращаем
    Если Не ЗначениеЗаполнено(ВариантКалькуляции) Тогда
        Сообщить("Вариант калькуляции не выбран");
        Возврат МассивАвтодеталей;
    КонецЕсли;
    
    // Получаем имя варианта
    ИмяВарианта = Строка(ВариантКалькуляции);
    Сообщить("Имя варианта (строка): " + ИмяВарианта);
    
    // Определяем номер варианта (1, 2 или 3)
    НомерВарианта = 1; // По умолчанию
    
    Если ИмяВарианта = "Вариант1" Тогда
        НомерВарианта = 1;
    ИначеЕсли ИмяВарианта = "Вариант2" Тогда
        НомерВарианта = 2;
    ИначеЕсли ИмяВарианта = "Вариант3" Тогда
        НомерВарианта = 3;
    Иначе
        // Пробуем извлечь номер из строки
        Попытка
            Если Найти(ИмяВарианта, "1") > 0 Тогда
                НомерВарианта = 1;
            ИначеЕсли Найти(ИмяВарианта, "2") > 0 Тогда
                НомерВарианта = 2;
            ИначеЕсли Найти(ИмяВарианта, "3") > 0 Тогда
                НомерВарианта = 3;
            КонецЕсли;
        Исключение
            НомерВарианта = 1;
        КонецПопытки;
    КонецЕсли;
    
    Сообщить("Используем вариант №" + НомерВарианта);
    
    // Проходим по всем строкам автодеталей в калькуляции
    Для Каждого СтрокаАвтодетали Из ДокументОбъект.Автодетали Цикл
        
        Материал = Неопределено;
        Цена = 0;
        Сумма = 0;
        
        // В зависимости от выбранного варианта берем соответствующие поля
        Если НомерВарианта = 1 Тогда
            Материал = СтрокаАвтодетали.Материал1;
            Цена = СтрокаАвтодетали.Цена1;
            Сумма = СтрокаАвтодетали.Сумма1;
            
        ИначеЕсли НомерВарианта = 2 Тогда
            Материал = СтрокаАвтодетали.Материал2;
            Цена = СтрокаАвтодетали.Цена2;
            Сумма = СтрокаАвтодетали.Сумма2;
            
        ИначеЕсли НомерВарианта = 3 Тогда
            Материал = СтрокаАвтодетали.Материал3;
            Цена = СтрокаАвтодетали.Цена3;
            Сумма = СтрокаАвтодетали.Сумма3;
            
        КонецЕсли;
        
        // Если материал для выбранного варианта заполнен
        Если ЗначениеЗаполнено(Материал) Тогда
            
            СтруктураАвтодетали = Новый Структура();
            
            // Основные поля
            СтруктураАвтодетали.Вставить("Автодеталь", СтрокаАвтодетали.Автодеталь);
            СтруктураАвтодетали.Вставить("Количество", СтрокаАвтодетали.Количество);
            
            // Данные из выбранного варианта
            СтруктураАвтодетали.Вставить("Материал", Материал);
            СтруктураАвтодетали.Вставить("Цена", Цена);
            СтруктураАвтодетали.Вставить("Сумма", Сумма);
            
            // Ссылка на работу (если есть)
            Если ЗначениеЗаполнено(СтрокаАвтодетали.СсылкаНаРаботу) Тогда
                СтруктураАвтодетали.Вставить("СсылкаНаРаботу", СтрокаАвтодетали.СсылкаНаРаботу);
            КонецЕсли;
            
            МассивАвтодеталей.Добавить(СтруктураАвтодетали);
            
            Сообщить("Добавлена автодеталь: " + СтрокаАвтодетали.Автодеталь + 
                    " -> материал: " + Материал + 
                    ", цена: " + Цена + 
                    ", количество: " + СтрокаАвтодетали.Количество);
        КонецЕсли;
        
    КонецЦикла;
    
    Сообщить("Всего автодеталей: " + МассивАвтодеталей.Количество());
    
    Возврат МассивАвтодеталей;
    
КонецФункции


&НаКлиенте
Процедура ОбновитьВсеДанные()
    
    Сообщить("=== ОбновитьВсеДанные ===");
    
    // Если калькуляция не выбрана - очищаем всё
    Если НЕ ЗначениеЗаполнено(Объект.Калькуляция) Тогда
        Объект.Клиент = Неопределено;
        Объект.Автомобиль = Неопределено;
        Объект.ПричинаОбращения = Неопределено;
        Объект.Работы.Очистить();
        Объект.Материалы.Очистить();
        Элементы.Работы.Обновить();
        Элементы.Материалы.Обновить();
        Возврат;
    КонецЕсли;

    // Получаем данные с сервера
    Данные = ЗаполнитьИзКалькуляцииНаСервере(Объект.Калькуляция, Объект.ВариантКалькуляции);
    
    // Заполняем основные поля
    Объект.Клиент = Данные.Клиент;
    Объект.Автомобиль = Данные.Автомобиль;
    Объект.ПричинаОбращения = Данные.ПричинаОбращения;
    
    // Заполняем табличные части
    ЗаполнитьТаблицуРабот(Данные.Работы);
    ЗаполнитьТаблицуАвтодеталей(Данные.Автодетали);
    
КонецПроцедуры


//&НаКлиенте
//Процедура ВариантКалькуляцииПриИзменении(Элемент)
//    
//    Сообщить("Сработало2");
//
//    Если НЕ ЗначениеЗаполнено(Объект.Калькуляция) Тогда
//        Возврат;
//    КонецЕсли;
//
//    // Читаем данные через серверный вызов
//    Данные = ЗаполнитьИзКалькуляцииНаСервере(Объект.Калькуляция);
//    
//    // Обновляем форму
//    Если Данные.Свойство("Клиент") Тогда
//        Объект.Клиент = Данные.Клиент;
//    КонецЕсли;
//    
//    Если Данные.Свойство("Автомобиль") Тогда
//        Объект.Автомобиль = Данные.Автомобиль;
//    КонецЕсли;
//    
//    Если Данные.Свойство("ПричинаОбращения") Тогда
//        Объект.ПричинаОбращения = Данные.ПричинаОбращения;
//    КонецЕсли;
//    
//КонецПроцедуры

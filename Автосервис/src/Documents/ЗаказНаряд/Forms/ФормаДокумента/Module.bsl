
&НаСервере
Процедура ПечатьФормыНаСервере(ТабДок)
	Макет = Документы.ЗаказНаряд.ПолучитьМакет("МакетНачало");
	ТабДок.Очистить();
	Шапка1 = Макет.ПолучитьОбласть("Шапка1");
	Если НЕ ЗначениеЗаполнено(Объект.Номер) Тогда
		Номер = "Документ не проведен. Неопределено";
	Иначе
		Номер = Объект.Номер;
	КонецЕсли;
	Шапка1.Параметры.Номер = Номер;
	Год = Формат(Объект.Дата, "ДФ=гггг");
	Месяц = Формат(Объект.Дата, "ДФ=ММММ");
	День = Формат(Объект.Дата, "ДФ=дд");
	Шапка1.Параметры.Год = Год;
	Шапка1.Параметры.Месяц = Месяц;
	Шапка1.Параметры.День = День;
	ТабДок.Вывести(Шапка1);
	ТаблицаНаряд = Макет.ПолучитьОбласть("ТаблицаНаряд");
	ТаблицаНаряд.Параметры.Автомобиль = Объект.Автомобиль.Наименование;
	ТаблицаНаряд.Параметры.Номер = Объект.Автомобиль.Госномер;
	ТаблицаНаряд.Параметры.VIN = Объект.Автомобиль.НомерVIN;
	ТаблицаНаряд.Параметры.Пробег = Объект.Автомобиль.Пробег;
	ТаблицаНаряд.Параметры.Год = Объект.Автомобиль.ДатаВыпуска;
	ТаблицаНаряд.Параметры.Заказчик = Объект.Клиент.Наименование;
	ТаблицаНаряд.Параметры.Адрес = Объект.Клиент.АдресПроживанияИлиФактическийАдрес;
	ТаблицаНаряд.Параметры.Телефон = Объект.Клиент.ТелефонКонтактногоЛица;
	ТабДок.Вывести(ТаблицаНаряд);
	Область2 = Макет.ПолучитьОбласть("Область2");
	Дата2 = Формат(Объект.Дата, "ДЛФ=Д");
	Область2.Параметры.Дата2 = Дата2;
	Область2.Параметры.Номер = Номер;
	ТабДок.Вывести(Область2);
	Шапка2 = Макет.ПолучитьОбласть("Шапка2");
	ТабДок.Вывести(Шапка2);
	ТаблицаСложная = Макет.ПолучитьОбласть("ТаблицаСложная");
	Номер2 = 1;
	ЦенаНЧ = РегистрыСведений.СтоимостьНормаЧаса.ПолучитьПоследнее(Объект.Дата).Стоимость;
	СуммаРабот = 0;
	Для Каждого СтрокаРабот Из Объект.Работы Цикл
		ТаблицаСложная.Параметры.Исполнитель = "Исполнитель " + СтрокаРабот.МастерПриемщик.Наименование;
		ТаблицаСложная.Параметры.Номер2 = Номер2;
		Номер2 = Номер2 + 1;
		ТаблицаСложная.Параметры.НаименованиеРабот = СтрокаРабот.Работа.Наименование;
		ТаблицаСложная.Параметры.Кол = СтрокаРабот.Количество;
		ТаблицаСложная.Параметры.Норма = СтрокаРабот.НормаЧас;
		ТаблицаСложная.Параметры.ЦенаНЧ = ЦенаНЧ;
		ТаблицаСложная.Параметры.Сумма = ЦенаНЧ*СтрокаРабот.НормаЧас*СтрокаРабот.Количество;
		СуммаРабот = СуммаРабот + ЦенаНЧ*СтрокаРабот.НормаЧас*СтрокаРабот.Количество;
		ТабДок.Вывести(ТаблицаСложная);
	КонецЦикла;
	Шапка3 = Макет.ПолучитьОбласть("Шапка3");
	Шапка3.Параметры.СуммаРабот = СуммаРабот;
	Шапка3.Параметры.Дата2 = Дата2;
	Шапка3.Параметры.Номер = Номер;
	ТабДок.Вывести(Шапка3);
	ТаблицаСложная2 = Макет.ПолучитьОбласть("ТаблицаСложная2");
	Номер3 = 1;
	ИтогСумма = 0;
	Для Каждого СтрокаМатериалы Из Объект.Автодетали Цикл
		ТаблицаСложная2.Параметры.Номер3 = Номер3;
		Номер3 = Номер3 +1;
		Наименование2 = СтрокаМатериалы.Материал.Наименование;
		ТаблицаСложная2.Параметры.Наименование2 = Наименование2;
		ТаблицаСложная2.Параметры.Кол2 = СтрокаМатериалы.Количество;
		ТаблицаСложная2.Параметры.Цена2 = СтрокаМатериалы.Цена;
		ТаблицаСложная2.Параметры.Сумма2 = СтрокаМатериалы.Количество * СтрокаМатериалы.Цена;
		ИтогСумма = ИтогСумма + СтрокаМатериалы.Количество * СтрокаМатериалы.Цена;
		ТабДок.Вывести(ТаблицаСложная2);
	КонецЦикла;
	ИтоговаяСумма = Макет.ПолучитьОбласть("ИтоговаяСумма");
	ИтоговаяСумма.Параметры.ИтогСумма = ИтогСумма;
	ТабДок.Вывести(ИтоговаяСумма);
КонецПроцедуры

&НаКлиенте
Процедура ПечатьФормы(Команда)
	ТабДок = Новый ТабличныйДокумент();
	ПечатьФормыНаСервере(ТабДок);
	ТабДок.Показать()
КонецПроцедуры
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Устанавливаем дату документа на текущую дату
	Объект.Дата = ТекущаяДата();
	
	// Устанавливаем статус по умолчанию - "Приемка"
	Если Объект.Статус = Неопределено Или Объект.Статус.Пустая() Тогда
		Объект.Статус = Перечисления.СтатусЗаказНаряда.Приемка;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// 
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьДанные(Команда)
	
	// 
	Если Объект.Клиент = Неопределено Или Объект.Клиент.Пустая() Тогда
		Сообщить("Необходимо указать клиента!");
		Возврат;
	КонецЕсли;
	
	Если Объект.Автомобиль = Неопределено Или Объект.Автомобиль.Пустая() Тогда
		Сообщить("Необходимо указать автомобиль!");
		Возврат;
	КонецЕсли;
	
	ЗаполнитьДанныеНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДанныеНаСервере()
	
	// ываываываыва
	// 
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	Калькуляция.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.Калькуляция КАК Калькуляция
	|ГДЕ
	|	Калькуляция.Клиент = &Клиент
	|	И Калькуляция.Автомобиль = &Автомобиль
	|	И Калькуляция.Проведен = ИСТИНА
	|
	|УПОРЯДОЧИТЬ ПО
	|	Калькуляция.Дата УБЫВ
	|	, Калькуляция.МоментВремени УБЫВ";
	
	Запрос.УстановитьПараметр("Клиент", Объект.Клиент);
	Запрос.УстановитьПараметр("Автомобиль", Объект.Автомобиль);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Если Выборка.Следующий() Тогда
		// 
		Объект.Калькуляция = Выборка.Ссылка;
		ЗаполнитьИзКалькуляцииНаСервере();
	Иначе
		// 
		Сообщить("Калькуляция для данного клиента и автомобиля не найдена. Заполните данные вручную или создайте калькуляцию.");
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КлиентПриИзменении(Элемент)
	
	// 
	//
	
КонецПроцедуры

&НаКлиенте
Процедура СтатусПриИзменении(Элемент)
	
	// 
	Если Объект.Статус = Неопределено Или Объект.Статус.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	//
	// 
	
КонецПроцедуры

&НаКлиенте
Процедура КалькуляцияПриИзменении(Элемент)
	
	// 
	Если Объект.Калькуляция <> Неопределено И Не Объект.Калькуляция.Пустая() Тогда
		ЗаполнитьИзКалькуляцииНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьИзКалькуляцииНаСервере()
	
	// 
	Если Объект.Калькуляция = Неопределено Или Объект.Калькуляция.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	ДокументКалькуляция = Объект.Калькуляция.ПолучитьОбъект();
	
	//
	Объект.Работы.Очистить();
	Для Каждого СтрокаРаботы Из ДокументКалькуляция.Работы Цикл
		НоваяСтрокаРаботы = Объект.Работы.Добавить();
		НоваяСтрокаРаботы.Работа = СтрокаРаботы.Работа;
		НоваяСтрокаРаботы.Количество = СтрокаРаботы.Количество;
		НоваяСтрокаРаботы.НормаЧас = СтрокаРаботы.НормаЧас;
		НоваяСтрокаРаботы.Сумма = СтрокаРаботы.НормаЧас * СтрокаРаботы.Количество;
	КонецЦикла;
	
	// 
	Объект.Автодетали.Очистить();
	Для Каждого СтрокаДетали Из ДокументКалькуляция.Автодетали Цикл
		НоваяСтрокаДетали = Объект.Автодетали.Добавить();
		НоваяСтрокаДетали.Автодеталь = СтрокаДетали.Автодеталь;
		НоваяСтрокаДетали.Количество = СтрокаДетали.Количество;
		// 
		НоваяСтрокаДетали.ДетальКлиента = Ложь;
	КонецЦикла;
	
КонецПроцедуры



&НаСервере
Функция ПолучитьНормаЧасРаботы(Работа)
	
	Если Работа = Неопределено Или Работа.Пустая() Тогда
		Возврат 0;
	КонецЕсли;
	
	Попытка
		РаботаОбъект = Работа.ПолучитьОбъект();
		Если РаботаОбъект.Свойство("НормаЧас") Тогда
			Возврат РаботаОбъект.НормаЧас;
		Иначе
			Возврат 0;
		КонецЕсли;
	Исключение
		Возврат 0;
	КонецПопытки;
	
КонецФункции

&НаКлиенте
Функция ПолучитьНормаЧасРаботыНаСервере(Работа)
	
	Возврат ПолучитьНормаЧасРаботы(Работа);
	
КонецФункции



//&НаСервере
//Функция РассчитатьНормаЧасы(Работа, Количество)
//	РаботаОбъект = Работа.ПолучитьОбъект();
//	Возврат РаботаОбъект.НормаЧас * Количество
//КонецФункции

&НаКлиенте
Процедура ПересчитатьСуммуРаботы(СтрокаРаботы)
	
	Если СтрокаРаботы = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// 
	СтрокаРаботы.Сумма = СтрокаРаботы.НормаЧас * СтрокаРаботы.Количество;
	
КонецПроцедуры





//&НаКлиенте
//Процедура АвтодеталиРаботыМатериалПриИзменении(Элемент)
//	
//	// 
////	СтрокаДетали = Элементы.Автодетали.ТекущиеДанные;
////	Если СтрокаДетали = Неопределено Тогда
////		Возврат;
////	КонецЕсли;
////	
////	// 
////	Если СтрокаДетали.ДетальКлиента Тогда
////		СтрокаДетали.Цена = 0;
////		СтрокаДетали.Сумма = 0;
////		Возврат;
////	КонецЕсли;
////	
////	Если СтрокаДетали.Материал <> Неопределено И Не СтрокаДетали.Материал.Пустая() Тогда
////		// 
////		Цена = ПолучитьЦену(СтрокаДетали.Материал);
////		Если Цена > 0 Тогда
////			СтрокаДетали.Цена = Цена;
////			ПересчитатьСуммуДетали(СтрокаДетали);
////		Иначе
////			СтрокаДетали.Цена = 0;
////			СтрокаДетали.Сумма = 0;
////		КонецЕсли;
////	КонецЕсли;
//
//	Сообщить("Произошло изменение ");
//
//	Материал = Элементы.Автодетали.ТекущиеДанные.АвтодеталиМатериал;
//	Количество = Элементы.Автодетали.ТекущиеДанные.АвтодеталиыКоличество;
//	Цена = ПолучитьЦену(Материал);
//	ДетальКлиента = Элементы.Автодетали.ТекущиеДанные.ДетальКлиента;
//	Если Не ДетальКлиента Тогда
//		Элементы.Автодетали.ТекущиеДанные.АвтодеталиЦена = Цена;
//		Элементы.Автодетали.ТекущиеДанные.АвтодеталиСумма = Цена*Количество;
//	КонецЕсли;
//	
//	
//	
//КонецПроцедуры

&НаСервере
Функция ПолучитьЦенуМатериала(Материал)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	СтоимостьМатериалов.Материал,
	|	СтоимостьМатериалов.Стоимость
	|ИЗ
	|	РегистрСведений.СтоимостьМатериалов КАК СтоимостьМатериалов
	|ГДЕ
    |   СтоимостьМатериалов.Материал = &Материал";
    Запрос.УстановитьПараметр(
        "Материал", Материал    
    );
    РезультатЗапроса = Запрос.Выполнить();
    Записи = РезультатЗапроса.Выбрать();
    Пока Записи.Следующий() Цикл
        Возврат Записи.Стоимость;
    КонецЦикла;
КонецФункции





&НаКлиенте
Функция ПолучитьЦену(Материал)
	
	Возврат ПолучитьЦенуМатериала(Материал);
	
КонецФункции

&НаКлиенте
Процедура АвтодеталиКоличествоПриИзменении(Элемент)
	
	// 
//	СтрокаДетали = Элементы.Автодетали.ТекущиеДанные;
//	Если СтрокаДетали <> Неопределено Тогда
//		// 
//		Если СтрокаДетали.ДетальКлиента Тогда
//			СтрокаДетали.Сумма = 0;
//		Иначе
//			ПересчитатьСуммуДетали(СтрокаДетали);
//		КонецЕсли;
//	КонецЕсли;
	Сообщить("Произошло изменение ");

	Материал = Элементы.Автодетали.ТекущиеДанные.Материал;
	Количество = Элементы.Автодетали.ТекущиеДанные.Количество;
	Цена = ПолучитьЦену(Материал);
//	Элементы.Автодетали.ТекущиеДанные.Цена = Цена;
//	Элементы.Автодетали.ТекущиеДанные.Сумма = Цена*Количество;
	ДетальКлиента = Элементы.Автодетали.ТекущиеДанные.ДетальКлиента;
	Если Не ДетальКлиента Тогда
		Элементы.Автодетали.ТекущиеДанные.Цена = Цена;
		Элементы.Автодетали.ТекущиеДанные.Сумма = Цена*Количество;
	Иначе
		Элементы.Автодетали.ТекущиеДанные.Цена = 0;
		Элементы.Автодетали.ТекущиеДанные.Сумма = 0;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция РассчитатьНормаЧасы(Работа, Количество)
	РаботаОбъект = Работа.ПолучитьОбъект();
	Возврат РаботаОбъект.НормаЧас * Количество
КонецФункции

&НаСервере
Функция РассчитатьСтоимостьНормаЧасы()
	Запись = РегистрыСведений.СтоимостьНормаЧаса.ПолучитьПоследнее(Объект.Дата);
	Если Запись = Неопределено Тогда
        // Если запись не найдена, вернуть 0 или значение по умолчанию
        Возврат 0;
    КонецЕсли;
    
    // Возвращаем только значение ресурса "Стоимость"
    Возврат Запись.Стоимость;
КонецФункции

&НаКлиенте
Процедура РаботыКоличествоПриИзменении(Элемент)
	
	// 
//	СтрокаТабличнойЧасти = Элементы.Работы.ТекущиеДанные;
//	СтрокаТабличнойЧасти.НормаЧас = РассчитатьНормаЧасы(СтрокаТабличнойЧасти.Работа, СтрокаТабличнойЧасти.Количество);
//    НовыеДетали = ПолучитьДеталиРаботыСУчетомКоличество(
//        СтрокаТабличнойЧасти.Работа,
//        СтрокаТабличнойЧасти.Количество
//    );

	Работа = Элементы.Работы.ТекущиеДанные.Работа;
	Количество = Элементы.Работы.ТекущиеДанные.Количество;
	
	Нормачасы = РассчитатьНормаЧасы(Работа, Количество);
	
	Элементы.Работы.ТекущиеДанные.Нормачас = Нормачасы;
	
	СтоимостьНормаЧаса = РассчитатьСтоимостьНормаЧасы();
	
//	Сообщить(СтоимостьНормаЧаса + " ывпывап");
	
	Элементы.Работы.ТекущиеДанные.Сумма = Нормачасы * СтоимостьНормаЧаса;
	
	
	
КонецПроцедуры

&НаКлиенте
Процедура РаботыРаботаПриИзменении(Элемент)
	
	Работа = Элементы.Работы.ТекущиеДанные.Работа;
	Количество = Элементы.Работы.ТекущиеДанные.Количество;
	
	Нормачасы = РассчитатьНормаЧасы(Работа, Количество);
	
	Элементы.Работы.ТекущиеДанные.Нормачас = Нормачасы;
	
	СтоимостьНормаЧаса = РассчитатьСтоимостьНормаЧасы();
	
//	Сообщить(СтоимостьНормаЧаса + " ывпывап");
	
	Элементы.Работы.ТекущиеДанные.Сумма = Нормачасы * СтоимостьНормаЧаса;
	
КонецПроцедуры




&НаКлиенте
Процедура РаботыНормаЧасПриИзменении(Элемент)
	
	Работа = Элементы.Работы.ТекущиеДанные.Работа;
	Количество = Элементы.Работы.ТекущиеДанные.Количество;
	
	Нормачасы = Элементы.Работы.ТекущиеДанные.Нормачас;
//	
//	Нормачасы = Нормачасы * Количество;
	
	СтоимостьНормаЧаса = РассчитатьСтоимостьНормаЧасы();
	
//	Сообщить(СтоимостьНормаЧаса + " ывпывап");
	
	Элементы.Работы.ТекущиеДанные.Сумма = Нормачасы * СтоимостьНормаЧаса;
	
	//TODO: Вставить содержимое обработчика
КонецПроцедуры





&НаКлиенте
Процедура АвтодеталиДетальКлиентаПриИзменении(Элемент)
	
	// 
//	СтрокаДетали = Элементы.Автодетали.ТекущиеДанные;
//	Если СтрокаДетали = Неопределено Тогда
//		Возврат;
//	КонецЕсли;
	ДетальКлиента = Элементы.Автодетали.ТекущиеДанные.ДетальКлиента;
	Если Не ДетальКлиента Тогда
		Материал = Элементы.Автодетали.ТекущиеДанные.Материал;
		Количество = Элементы.Автодетали.ТекущиеДанные.Количество;
		Цена = ПолучитьЦену(Материал);
		Элементы.Автодетали.ТекущиеДанные.Цена = Цена;
		Элементы.Автодетали.ТекущиеДанные.Сумма = Цена*Количество;
	Иначе
		Элементы.Автодетали.ТекущиеДанные.Цена = 0;
		Элементы.Автодетали.ТекущиеДанные.Сумма = 0;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура АвтодеталиАвтодетальПриИзменении(Элемент)
	
	// 
	
КонецПроцедуры

&НаКлиенте
Процедура АвтодеталиМатериалПриИзменении(Элемент)
	ДетальКлиента = Элементы.Автодетали.ТекущиеДанные.ДетальКлиента;
	Если Не ДетальКлиента Тогда
		Материал = Элементы.Автодетали.ТекущиеДанные.Материал;
		Количество = Элементы.Автодетали.ТекущиеДанные.Количество;
		Цена = ПолучитьЦену(Материал);
		Элементы.Автодетали.ТекущиеДанные.Цена = Цена;
		Элементы.Автодетали.ТекущиеДанные.Сумма = Цена*Количество;
	Иначе
		Элементы.Автодетали.ТекущиеДанные.Цена = 0;
		Элементы.Автодетали.ТекущиеДанные.Сумма = 0;
	КонецЕсли;
	//TODO: Вставить содержимое обработчика
КонецПроцедуры

//&НаКлиенте
//Процедура АвтодеталиЦенаПриИзменении(Элемент)
//	
//	// 
//	СтрокаДетали = Элементы.Автодетали.ТекущиеДанные;
//	Если СтрокаДетали <> Неопределено Тогда
//		//
//		Если СтрокаДетали.ДетальКлиента Тогда
//			СтрокаДетали.Сумма = 0;
//		Иначе
//			ПересчитатьСуммуДетали(СтрокаДетали);
//		КонецЕсли;
//	КонецЕсли;
//	
//КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьСуммуДетали(СтрокаДетали)
	
	Если СтрокаДетали = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	//
	Если СтрокаДетали.ДетальКлиента Тогда
		СтрокаДетали.Сумма = 0;
		Возврат;
	КонецЕсли;
	
	// 
	СтрокаДетали.Сумма = СтрокаДетали.Цена * СтрокаДетали.Количество;
	
КонецПроцедуры